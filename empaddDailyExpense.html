<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Staff Daily Transport Expense</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

</head>

<body class="">
  <nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid py-3">
      <a class="navbar-brand fw-bold fs-1" href="#">EduPublications</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo02"
        aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0 gap-1 fw-bold fs-6 pt-1 px-3">
          <li class="nav-item">
            <a class="nav-link " aria-current="page" href="index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link admin" aria-current="page" href="addDivision.html">Division</a>
          </li>
          <li class="nav-item">
            <a class="nav-link admin" aria-current="page" href="addDistrict.html">District</a>
          </li>
          <li class="nav-item">
            <a class="nav-link admin" aria-current="page" href="addUpazila.html">Upazila</a>
          </li>
          <li class="nav-item">
            <a class="nav-link admin" aria-current="page" href="addUnion.html">Union</a>
          </li>
          <li class="nav-item">
            <a class="nav-link admin" aria-current="page" href="clgFilter.html">College</a>
          </li>
          <li class="nav-item">
            <a class="nav-link admin" aria-current="page" href="addTeacher.html">Teacher</a>
          </li>
          <li class="nav-item">
            <a class="nav-link admin" aria-current="page" href="addgift.html">Gift</a>
          </li>
          <li class="nav-item">
            <a class="nav-link admin" aria-current="page" href="addemployee.html">Employee</a>
          </li>
          <li class="nav-item">
            <a class="nav-link admin" aria-current="page" href="addDailyExpense.html">TrnsPExpense</a>
          </li>
          <li class="nav-item">
            <a class="nav-link admin" aria-current="page" href="addExpense.html">Expense</a>
          </li>
          <li class="nav-item">
            <a class="nav-link employee" aria-current="page" href="giftemployee.html">empGift</a>
          </li>
          <li class="nav-item">
            <a class="nav-link employee active" aria-current="page" href="empaddDailyExpense.html">empTEx</a>
          </li>
          <li class="nav-item">
            <a class="nav-link employee" aria-current="page" href="empaddExpense.html">empEX</a>
          </li>
          <!-- <li class="nav-item">
            <a class="nav-link login" aria-current="page" href="login.html">login</a>
          </li>
          <li class="nav-item">
            <a class="nav-link logout" aria-current="page" href="#" onclick="handlelogOut()">Logout</a>
          </li> -->

        </ul>
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0 gap-1 fw-bold fs-6 pt-1 px-3">
          <li class="nav-item"><a class="nav-link login" href="login.html">Login</a></li>
          <li class="nav-item"><a class="nav-link logout" href="#" onclick="handlelogOut()">Logout</a></li>
        </ul>

      </div>
    </div>
  </nav>
  <div class="container">
    <h2 class="mb-4">Staff Daily Transport Expenses</h2>

    <!-- Add Expense Button -->
    <button class="btn btn-primary mb-3" onclick="openAddModal()">Add Expense</button>

    <!-- Expense Table -->
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>ID</th>
          <th>Employee ID</th>
          <th>Emp Name</th>
          <th>Expense Type</th>
          <th>From</th>
          <th>To</th>
          <th>Total</th>
          <th>Approve</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="expenseTableBody"></tbody>
      <tfoot>
        <tr>
          <td colspan="6" class="text-end fw-bold bg-dark text-white">Total</td>
          <td id="totalExpenseSum" class="fw-bold bg-dark text-white"></td>
          <td class="bg-dark text-white" colspan="3"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="expenseModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="expenseForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Add Expense</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="expenseId">
          <!-- <div class="mb-3">
            <label for="employee" class="form-label">Employee</label>
            <select class="form-select" id="employee" required>
              <option value="">Select Employee</option>
            </select>
          </div> -->
          <div class="mb-3">
            <label for="employee" class="form-label">Employee</label>
            <input type="text" class="form-control" id="employee_name_display" readonly>
            <input type="hidden" id="employee" required>
          </div>

          <!-- <div class="mb-3">
            <label for="expense_type" class="form-label">Expense Type</label>
            <input type="text" class="form-control" id="expense_type" required>
          </div> -->
          <div class="mb-3">
            <label for="expense_type" class="form-label">Expense Type</label>
            <input type="text" class="form-control" id="expense_type" value="Transport Bill" readonly>
          </div>

          <div class="mb-3">
            <label for="travel_from" class="form-label">From</label>
            <input type="text" class="form-control" id="travel_from" required>
          </div>
          <div class="mb-3">
            <label for="travel_to" class="form-label">To</label>
            <input type="text" class="form-control" id="travel_to" required>
          </div>
          <div class="mb-3">
            <label for="total_expense" class="form-label">Total Expense</label>
            <input type="number" class="form-control" id="total_expense" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const expenseApi = "https://publication-tm35.onrender.com/employee/sde/";
    const employeeApi = "https://publication-tm35.onrender.com/employee/list/";
    const modal = new bootstrap.Modal(document.getElementById('expenseModal'));
    let employeeMap = {};

    async function fetchEmployees() {
      const res = await fetch(employeeApi);
      const data = await res.json();
      const select = document.getElementById('employee');
      select.innerHTML = '<option value="">Select Employee</option>';
      employeeMap = {};
      data.forEach(emp => {
        const fullName = `${emp.employee_name}`;
        employeeMap[emp.id] = fullName;
        const option = document.createElement('option');
        option.value = emp.id;
        option.textContent = fullName;
        select.appendChild(option);
      });
    }

    async function loadExpenses() {
      const res = await fetch(expenseApi);
      const data = await res.json();
      const tbody = document.getElementById('expenseTableBody');
      const totalCell = document.getElementById('totalExpenseSum');
      const employeeId = localStorage.getItem('employeeid');
      let foundData = false;
      tbody.innerHTML = '';
      let totalSum = 0;


      data.forEach(exp => {
        if (exp.employee == employeeId) {
          foundData = true;
          totalSum += parseFloat(exp.total_expense || 0);
          tbody.innerHTML += `
            <tr>
              <td>${exp.id}</td>
              <td>${exp.employee}</td>
              <td>${exp.employee_name || employeeMap[exp.employee] || 'N/A'}</td>
              <td>${exp.expense_type}</td>
              <td>${exp.travel_from}</td>
              <td>${exp.travel_to}</td>
              <td>${exp.total_expense}</td>
              <td>${exp.approve ? 'Yes' : 'No'}</td>
              <td>${new Date(exp.created_at).toLocaleString()}</td>
              <td>
                ${exp.approve
              ? `<button class="btn btn-sm" style="background-color: green; color: white;" disabled>Approved</button>`
              : exp.reject
                ? `<button class="btn btn-sm btn-danger" disabled>Rejected</button>`
                : `
                    <button class="btn btn-sm btn-info " onclick='editExpense(${JSON.stringify(exp)})' >Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteExpense(${exp.id})" >Delete</button>
                    `
            }
                
              </td>
            </tr>
        `;
        }
      });

      totalCell.textContent = totalSum.toFixed(2);
      if (!foundData) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-danger">No data found</td>
            </tr>
        `;
      }
    }

    document.getElementById('expenseForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const id = document.getElementById('expenseId').value;
      const employeeId = localStorage.getItem("employeeid");

      const data = {
        employee: document.getElementById('employee').value,
        expense_type: document.getElementById('expense_type').value,
        travel_from: document.getElementById('travel_from').value,
        travel_to: document.getElementById('travel_to').value,
        total_expense: document.getElementById('total_expense').value
      };

      const method = id ? 'PUT' : 'POST';
      const url = id ? expenseApi + id + '/' : expenseApi;

      const res = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        modal.hide();
        loadExpenses();
      } else {
        alert('Failed to save expense');
      }
    });

    // function openAddModal() {
    //   document.getElementById('modalTitle').textContent = 'Add Expense';
    //   document.getElementById('expenseForm').reset();
    //   document.getElementById('expenseId').value = '';
    //   modal.show();
    // }
    function openAddModal() {
      document.getElementById('modalTitle').textContent = 'Add Expense';
      document.getElementById('expenseForm').reset();
      document.getElementById('expenseId').value = '';

      const employeeId = localStorage.getItem('employeeid');
      const employeeName = employeeMap[employeeId] || "Unknown";

      document.getElementById('employee').value = employeeId;
      document.getElementById('employee_name_display').value = employeeName;

      modal.show();
    }


    // function editExpense(exp) {
    //   document.getElementById('modalTitle').textContent = 'Edit Expense';
    //   document.getElementById('expenseId').value = exp.id;
    //   document.getElementById('employee').value = exp.employee;
    //   document.getElementById('expense_type').value = exp.expense_type;
    //   document.getElementById('travel_from').value = exp.travel_from;
    //   document.getElementById('travel_to').value = exp.travel_to;
    //   document.getElementById('total_expense').value = exp.total_expense;
    //   modal.show();
    // }
    function editExpense(exp) {
      document.getElementById('modalTitle').textContent = 'Edit Expense';
      document.getElementById('expenseId').value = exp.id;

      document.getElementById('employee').value = exp.employee;
      document.getElementById('employee_name_display').value = employeeMap[exp.employee] || exp.employee_name || 'Unknown';

      document.getElementById('expense_type').value = exp.expense_type;
      document.getElementById('travel_from').value = exp.travel_from;
      document.getElementById('travel_to').value = exp.travel_to;
      document.getElementById('total_expense').value = exp.total_expense;

      modal.show();
    }





    async function deleteExpense(id) {
      if (confirm("Are you sure you want to delete this expense?")) {
        const res = await fetch(expenseApi + id + '/', { method: 'DELETE' });
        if (res.ok) {
          loadExpenses();
        } else {
          alert("Failed to delete.");
        }
      }
    }

    // Initial load
    fetchEmployees().then(loadExpenses);
  </script>
  <script src="roleHandler.js"></script>
  <script src="logout.js"></script>
</body>

</html>
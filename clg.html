<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>College Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

<div class="container">
  <h2 class="mb-4">College List</h2>
  <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#collegeModal">Add College</button>

  <table class="table table-bordered" id="collegeTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Code</th>
        <th>Division</th>
        <th>District</th>
        <th>Upazila</th>
        <th>Union</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="collegeModal" tabindex="-1" aria-labelledby="collegeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="collegeForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="collegeModalLabel">Add College</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editCollegeId" />
        <div class="mb-2">
          <label>College Name</label>
          <input type="text" class="form-control" name="name" required />
        </div>
        <div class="mb-2">
          <label>College Code</label>
          <input type="number" class="form-control" name="college_code" required />
        </div>

        <div class="mb-2">
          <label>Division</label>
          <select class="form-select" id="divisionSelect" required></select>
        </div>
        <div class="mb-2">
          <label>District</label>
          <select class="form-select" id="districtSelect" required></select>
        </div>
        <div class="mb-2">
          <label>Upazila</label>
          <select class="form-select" id="upazilaSelect" required></select>
        </div>
        <div class="mb-2">
          <label>Union</label>
          <select class="form-select" id="unionSelect" required></select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Save College</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </form>
  </div>
</div>

<script>
const divisionSelect = document.getElementById("divisionSelect");
const districtSelect = document.getElementById("districtSelect");
const upazilaSelect = document.getElementById("upazilaSelect");
const unionSelect = document.getElementById("unionSelect");
const collegeTableBody = document.querySelector("#collegeTable tbody");

let divisions = [];
let districts = [];
let upazilas = [];
let unions = [];

async function loadData(url) {
  const res = await fetch(url);
  return res.json();
}

async function populateSelect(select, data, filterKey = null, filterValue = null) {
  select.innerHTML = '<option value="">Select</option>';
  data.filter(item => !filterKey || item[filterKey] == filterValue)
      .forEach(item => {
        select.innerHTML += `<option value="${item.id}">${item.name}</option>`;
      });
}

async function initializeDropdowns() {
  divisions = await loadData("http://127.0.0.1:8000/college/divisions/");
  districts = await loadData("http://127.0.0.1:8000/college/districts/");
  upazilas = await loadData("http://127.0.0.1:8000/college/upazilas/");
  unions = await loadData("http://127.0.0.1:8000/college/unions/");

  populateSelect(divisionSelect, divisions);

  divisionSelect.onchange = () => {
    populateSelect(districtSelect, districts, "division", divisionSelect.value);
    upazilaSelect.innerHTML = '<option value="">Select</option>';
    unionSelect.innerHTML = '<option value="">Select</option>';
  };
  districtSelect.onchange = () => {
    populateSelect(upazilaSelect, upazilas, "district", districtSelect.value);
    unionSelect.innerHTML = '<option value="">Select</option>';
  };
  upazilaSelect.onchange = () => {
    populateSelect(unionSelect, unions, "upazila", upazilaSelect.value);
  };
}

async function loadColleges() {
  const res = await fetch("http://127.0.0.1:8000/college/colleges/");
  const colleges = await res.json();
  collegeTableBody.innerHTML = "";
  for (let col of colleges) {
    const row = `
      <tr>
        <td>${col.id}</td>
        <td>${col.name}</td>
        <td>${col.college_code}</td>
        <td>${getNameById(divisions, col.division)}</td>
        <td>${getNameById(districts, col.district)}</td>
        <td>${getNameById(upazilas, col.upazila)}</td>
        <td>${getNameById(unions, col.union)}</td>

        <td>
          <button class="btn btn-sm btn-warning" onclick='editCollege(${JSON.stringify(col)})'>Edit</button>
          <button class="btn btn-sm btn-danger" onclick='deleteCollege(${col.id})'>Delete</button>
        </td>
      </tr>`;
    collegeTableBody.innerHTML += row;
  }
}

function getNameById(list, id) {
  const item = list.find(i => i.id === id);
  return item ? item.name : 'N/A';
}


function editCollege(col) {
  document.getElementById("collegeModalLabel").innerText = "Edit College";
  document.getElementById("editCollegeId").value = col.id;
  document.querySelector("#collegeForm [name=name]").value = col.name;
  document.querySelector("#collegeForm [name=college_code]").value = col.college_code;

  divisionSelect.value = col.division;
  populateSelect(districtSelect, districts, "division", col.division);
  districtSelect.value = col.district;

  populateSelect(upazilaSelect, upazilas, "district", col.district);
  upazilaSelect.value = col.upazila;

  populateSelect(unionSelect, unions, "upazila", col.upazila);
  unionSelect.value = col.union;

  new bootstrap.Modal(document.getElementById("collegeModal")).show();
}

async function deleteCollege(id) {
  if (confirm("Are you sure you want to delete this college?")) {
    const res = await fetch(`http://127.0.0.1:8000/college/colleges/${id}/`, { method: "DELETE" });
    if (res.ok) {
      loadColleges();
    } else {
      alert("Failed to delete college.");
    }
  }
}

document.getElementById("collegeForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const id = document.getElementById("editCollegeId").value;
  const formData = {
    name: this.name.value,
    college_code: this.college_code.value,
    division: divisionSelect.value,
    district: districtSelect.value,
    upazila: upazilaSelect.value,
    union: unionSelect.value
  };

  const url = id ? `http://127.0.0.1:8000/college/colleges/${id}/` : "http://127.0.0.1:8000/college/colleges/";
  const method = id ? "PUT" : "POST";

  const res = await fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(formData)
  });

  if (res.ok) {
    bootstrap.Modal.getInstance(document.getElementById("collegeModal")).hide();
    this.reset();
    document.getElementById("editCollegeId").value = "";
    document.getElementById("collegeModalLabel").innerText = "Add College";
    await loadColleges();
  } else {
    alert("Failed to save college.");
  }
});

window.onload = async () => {
  await initializeDropdowns();
  await loadColleges();
};
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


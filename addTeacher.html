<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Teacher Management</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#teacherModal">Add Teacher</button>
  </div>

  <!-- Filters -->
  <div class="row mb-3">
    <div class="col"><select class="form-select" id="divisionFilter"><option value="">All Divisions</option></select></div>
    <div class="col"><select class="form-select" id="districtFilter"><option value="">All Districts</option></select></div>
    <div class="col"><select class="form-select" id="upazilaFilter"><option value="">All Upazilas</option></select></div>
    <div class="col"><select class="form-select" id="unionFilter"><option value="">All Unions</option></select></div>
    <div class="col"><select class="form-select" id="collegeFilter"><option value="">All Colleges</option></select></div>
    <div class="col"><input type="text" id="teacherNameFilter" class="form-control" placeholder="Search Teacher"></div>
  </div>

  <!-- Teacher Table -->
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Name</th><th>Designation</th><th>Subject</th><th>Phone</th><th>College</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="teacherTableBody"></tbody>
  </table>

  <!-- Add/Edit Modal -->
  <div class="modal fade" id="teacherModal" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="teacherForm">
        <div class="modal-header">
          <h5 class="modal-title">Add/Edit Teacher</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="teacherId">
          <input class="form-control mb-2" placeholder="Name" id="teacherName" required>
          <input class="form-control mb-2" placeholder="Designation" id="teacherDesignation" required>
          <input class="form-control mb-2" placeholder="Subject" id="teacherSubject" required>
          <input class="form-control mb-2" placeholder="Phone" id="teacherPhone" required>
          <select class="form-select mb-2" id="teacherDivision" required></select>
          <select class="form-select mb-2" id="teacherDistrict" required></select>
          <select class="form-select mb-2" id="teacherUpazila" required></select>
          <select class="form-select mb-2" id="teacherUnion" required></select>
          <select class="form-select mb-2" id="teacherCollege" required></select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JS & Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const baseURL = "http://127.0.0.1:8000/college/";
    let teachers = [], colleges = [], divisions = [], districts = [], upazilas = [], unions = [];

    async function fetchData() {
      [teachers, colleges, divisions, districts, upazilas, unions] = await Promise.all([
        fetch(baseURL + "teachers/").then(res => res.json()),
        fetch(baseURL + "colleges/").then(res => res.json()),
        fetch(baseURL + "divisions/").then(res => res.json()),
        fetch(baseURL + "districts/").then(res => res.json()),
        fetch(baseURL + "upazilas/").then(res => res.json()),
        fetch(baseURL + "unions/").then(res => res.json()),
      ]);
      renderFilters();
      renderTeachers();
      populateFormSelects();
    }

    function renderTeachers() {
      const tbody = document.getElementById("teacherTableBody");
      tbody.innerHTML = "";
      const filters = {
        division: divisionFilter.value,
        district: districtFilter.value,
        upazila: upazilaFilter.value,
        union: unionFilter.value,
        college: collegeFilter.value,
        name: teacherNameFilter.value.toLowerCase()
      };
      teachers.filter(t => {
        return (!filters.division || t.division == filters.division) &&
               (!filters.district || t.district == filters.district) &&
               (!filters.upazila || t.upazila == filters.upazila) &&
               (!filters.union || t.union == filters.union) &&
               (!filters.college || t.college == filters.college) &&
               (!filters.name || t.name.toLowerCase().includes(filters.name));
      }).forEach(t => {
        const col = colleges.find(c => c.id == t.college)?.name || "N/A";
        tbody.innerHTML += `
          <tr>
            <td>${t.name}</td>
            <td>${t.designation}</td>
            <td>${t.subject}</td>
            <td>${t.phone}</td>
            <td>${col}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick='editTeacher(${JSON.stringify(t)})'>Edit</button>
              <button class="btn btn-sm btn-danger" onclick='deleteTeacher(${t.id})'>Delete</button>
            </td>
          </tr>`;
      });
    }

    function renderFilters() {
      const fill = (el, data, label) => {
        el.innerHTML = `<option value="">${label}</option>` + data.map(d => `<option value="${d.id}">${d.name}</option>`).join("");
      };
      fill(divisionFilter, divisions, "All Divisions");
      fill(districtFilter, districts, "All Districts");
      fill(upazilaFilter, upazilas, "All Upazilas");
      fill(unionFilter, unions, "All Unions");
      fill(collegeFilter, colleges, "All Colleges");
    }

    function populateFormSelects() {
      const fill = (el, data) => el.innerHTML = `<option value="">Select</option>` + data.map(d => `<option value="${d.id}">${d.name}</option>`).join("");
      fill(teacherDivision, divisions);
      fill(teacherDistrict, districts);
      fill(teacherUpazila, upazilas);
      fill(teacherUnion, unions);
      fill(teacherCollege, colleges);
    }

    document.getElementById("teacherForm").onsubmit = async function (e) {
      e.preventDefault();
      const payload = {
        name: teacherName.value,
        designation: teacherDesignation.value,
        subject: teacherSubject.value,
        phone: teacherPhone.value,
        division: teacherDivision.value,
        district: teacherDistrict.value,
        upazila: teacherUpazila.value,
        union: teacherUnion.value,
        college: teacherCollege.value
      };
      const id = teacherId.value;
      const method = id ? "PUT" : "POST";
      const url = baseURL + "teachers/" + (id ? `${id}/` : "");
      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        document.querySelector("#teacherModal .btn-close").click();
        await fetchData();
        e.target.reset();
        teacherId.value = "";
      }
    };

    function editTeacher(t) {
      teacherId.value = t.id;
      teacherName.value = t.name;
      teacherDesignation.value = t.designation;
      teacherSubject.value = t.subject;
      teacherPhone.value = t.phone;
      teacherDivision.value = t.division;
      teacherDistrict.value = t.district;
      teacherUpazila.value = t.upazila;
      teacherUnion.value = t.union;
      teacherCollege.value = t.college;
      new bootstrap.Modal(document.getElementById("teacherModal")).show();
    }

    async function deleteTeacher(id) {
      if (confirm("Delete this teacher?")) {
        await fetch(baseURL + "teachers/" + id + "/", { method: "DELETE" });
        await fetchData();
      }
    }

    // Filters trigger reload
    ["divisionFilter", "districtFilter", "upazilaFilter", "unionFilter", "collegeFilter", "teacherNameFilter"]
      .forEach(id => document.getElementById(id).oninput = renderTeachers);

    fetchData();
  </script>
</body>
</html>

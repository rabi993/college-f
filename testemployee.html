<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Employee Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .image-preview { height: 50px; }
  </style>
</head>
<body class="p-4">
<div class="container">
  <h2 class="mb-4">Employee Management</h2>

  <button class="btn btn-primary mb-3" id="openAddModalBtn">Add Employee</button>

  <table class="table table-bordered mt-2" id="employeeTable">
    <thead>
      <tr class="text-center">
        <th>ID</th>
        <th>Image</th>
        <th>User</th>
        <th>Mobile No</th>
        <th>Designation</th>
        <th>Address</th>
        <th class="bg-success text-white">Division</th>
        <th class="bg-success text-white">District</th>
        <th class="bg-success text-white">Upazila</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="employeeModal" tabindex="-1" aria-labelledby="employeeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="employeeForm" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="employeeModalLabel">Add Employee</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label for="userSelect" class="form-label">User</label>
              <select name="user" class="form-control" required id="userSelect"></select>
            </div>
            <div class="col-md-4">
              <label for="mobileNoInput" class="form-label">Mobile No</label>
              <input type="text" name="mobile_no" id="mobileNoInput" class="form-control" required />
            </div>
            <div class="col-md-4">
              <label for="designation" class="form-label">Designation</label>
              <input type="text" name="designation" id="designation" class="form-control" required />
            </div>
            <div class="col-md-4">
              <label for="address" class="form-label">Address</label>
              <textarea class="form-control" name="address" id="address" placeholder="Type address" required></textarea>
                    
            </div>
            <div class="col-md-4">
              <label for="imageInput" class="form-label">Image</label>
              <input type="file" name="image" id="imageInput" class="form-control" />
            </div>
            <div class="col-md-4">
              <label for="divisionSelect" class="form-label">Division</label>
              <select name="division" class="form-control" multiple id="divisionSelect"></select>
            </div>
            <div class="col-md-4">
              <label for="districtSelect" class="form-label">District</label>
              <select name="district" class="form-control" multiple id="districtSelect"></select>
            </div>
            <div class="col-md-4">
              <label for="upazilaSelect" class="form-label">Upazila</label>
              <select name="upazila" class="form-control" multiple id="upazilaSelect"></select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelEditBtn">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">Add Employee</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const baseUrl = 'http://127.0.0.1:8000';

  const userMap = {};
  const divisionMap = {};
  const districtMap = {};
  const upazilaMap = {};
  let allDistricts = [], allUpazilas = [];
  let editingId = null;

  const employeeModal = new bootstrap.Modal(document.getElementById('employeeModal'));

  async function loadOptions(url, selectId, mapObj, labelKey = 'name') {
    const select = document.getElementById(selectId);
    if (!select) return;
    try {
      const res = await fetch(url);
      const data = await res.json();
      select.innerHTML = '';
      data.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item[labelKey] || item.username || `ID: ${item.id}`;
        select.appendChild(option);
        mapObj[item.id] = item[labelKey] || item.username || `ID: ${item.id}`;
      });
      return data;
    } catch (err) {
      console.error(`Error loading ${selectId}:`, err);
    }
  }

  function getSelectedValues(select) {
    return Array.from(select.selectedOptions).map(o => parseInt(o.value));
  }

  function filterDistrictsByDivision(divisionIds) {
    const select = document.getElementById('districtSelect');
    select.innerHTML = '';
    const filtered = allDistricts.filter(d => divisionIds.includes(d.division));
    filtered.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.textContent = d.name;
      select.appendChild(opt);
    });
  }

  function filterUpazilasByDistrict(districtIds) {
    const select = document.getElementById('upazilaSelect');
    select.innerHTML = '';
    const filtered = allUpazilas.filter(u => districtIds.includes(u.district));
    filtered.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.id;
      opt.textContent = u.name;
      select.appendChild(opt);
    });
  }

  async function loadEmployees() {
    const res = await fetch(`${baseUrl}/employee/list/`);
    const employees = await res.json();
    const tbody = document.querySelector('#employeeTable tbody');
    tbody.innerHTML = '';
    employees.forEach(emp => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${emp.id}</td>
        <td><img src="${emp.image}" class="image-preview" /></td>
        <td>${userMap[emp.user] || emp.user}</td>
        <td>${emp.mobile_no}</td>
        <td>${emp.designation}</td>
        <td>${emp.address}</td>
        <td>${emp.division.map(id => divisionMap[id]).join(', ')}</td>
        <td>${emp.district.map(id => districtMap[id]).join(', ')}</td>
        <td>${emp.upazila.map(id => upazilaMap[id]).join(', ')}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1" onclick="editEmployee(${emp.id})">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteEmployee(${emp.id})">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function submitEmployee(formData) {
    let url = `${baseUrl}/employee/list/`;
    let method = 'POST';
    if (editingId) {
      url += `${editingId}/`;
      method = 'PUT';
    }
    const res = await fetch(url, { method, body: formData });
    if (!res.ok) {
      const error = await res.json();
      alert('Error: ' + JSON.stringify(error));
      return false;
    }
    return true;
  }

  document.getElementById('divisionSelect').addEventListener('change', () => {
    const selectedDivs = getSelectedValues(document.getElementById('divisionSelect'));
    filterDistrictsByDivision(selectedDivs);
    document.getElementById('upazilaSelect').innerHTML = '';
  });

  document.getElementById('districtSelect').addEventListener('change', () => {
    const selectedDists = getSelectedValues(document.getElementById('districtSelect'));
    filterUpazilasByDistrict(selectedDists);
  });

  document.getElementById('employeeForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    ['division', 'district', 'upazila'].forEach(name => formData.delete(name));
    getSelectedValues(document.getElementById('divisionSelect')).forEach(v => formData.append('division', v));
    getSelectedValues(document.getElementById('districtSelect')).forEach(v => formData.append('district', v));
    getSelectedValues(document.getElementById('upazilaSelect')).forEach(v => formData.append('upazila', v));

    const success = await submitEmployee(formData);
    if (success) {
      form.reset();
      editingId = null;
      employeeModal.hide();
      loadEmployees();
    }
  });

  async function editEmployee(id) {
    const res = await fetch(`${baseUrl}/employee/list/${id}/`);
    const emp = await res.json();
    document.getElementById('userSelect').value = emp.user;
    document.getElementById('mobileNoInput').value = emp.mobile_no;
    document.getElementById('designation').value = emp.designation;
    document.getElementById('address').value = emp.address;

    document.getElementById('divisionSelect').value = null;
    filterDistrictsByDivision(emp.division);
    emp.division.forEach(id => {
      const opt = [...document.getElementById('divisionSelect').options].find(o => o.value == id);
      if (opt) opt.selected = true;
    });

    filterUpazilasByDistrict(emp.district);
    emp.district.forEach(id => {
      const opt = [...document.getElementById('districtSelect').options].find(o => o.value == id);
      if (opt) opt.selected = true;
    });

    emp.upazila.forEach(id => {
      const opt = [...document.getElementById('upazilaSelect').options].find(o => o.value == id);
      if (opt) opt.selected = true;
    });

    editingId = emp.id;
    document.getElementById('submitBtn').textContent = 'Update Employee';
    document.getElementById('employeeModalLabel').textContent = 'Edit Employee';
    employeeModal.show();
  }

  async function deleteEmployee(id) {
    if (!confirm('Are you sure?')) return;
    await fetch(`${baseUrl}/employee/list/${id}/`, { method: 'DELETE' });
    loadEmployees();
  }

  document.getElementById('openAddModalBtn').addEventListener('click', () => {
    editingId = null;
    document.getElementById('employeeForm').reset();
    document.getElementById('submitBtn').textContent = 'Add Employee';
    document.getElementById('employeeModalLabel').textContent = 'Add Employee';
    document.getElementById('districtSelect').innerHTML = '';
    document.getElementById('upazilaSelect').innerHTML = '';
    employeeModal.show();
  });

  async function initialize() {
    await loadOptions(`${baseUrl}/users/`, 'userSelect', userMap, 'username');
    await loadOptions(`${baseUrl}/college/divisions/`, 'divisionSelect', divisionMap);
    allDistricts = await loadOptions(`${baseUrl}/college/districts/`, 'districtSelect', districtMap);
    allUpazilas = await loadOptions(`${baseUrl}/college/upazilas/`, 'upazilaSelect', upazilaMap);
    loadEmployees();
  }

  initialize();
</script>
</body>
</html>
